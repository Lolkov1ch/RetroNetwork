{% extends "base.html" %}
{% block title %}RetroNetwork | Posts{% endblock %}
{% block content %}

<div class="panel">
  <div class="panel-header">[ Post Feed ]</div>
  <div class="panel-body" style="padding:6px;">

    <div class="post-list" id="posts-container">
      {% for post in posts %}
        <a href="{% url 'posts:post_detail' post.pk %}" class="post-link">
          <div class="post">
            {% if post.thumbnail_url %}
              <div class="post-thumbnail-container">
                <img src="/media/{{ post.thumbnail_url }}" alt="{{ post.title }}">
                <div class="post-thumbnail-overlay"></div>
              </div>
            {% elif post.images or post.videos %}
              <div class="post-thumbnail-container">
                {% if post.images %}
                  <img src="{{ post.images.0.file.url }}" alt="{{ post.title }}">
                {% elif post.videos %}
                  <video><source src="{{ post.videos.0.file.url }}" type="video/mp4"></video>
                {% endif %}
                <div class="post-thumbnail-overlay"></div>
              </div>
            {% endif %}
            <div class="post-info">
              <h2>{{ post.title|truncatewords:5 }}</h2>
              <p class="post-description">{{ post.description|truncatewords:10 }}</p>
              <div class="post-meta">
                <span>by <a href="{% url 'users:user_detail' post.author.handle %}">@{{ post.author.handle }}</a></span>
                <span>{{ post.created_at|date:"d.m.Y H:i" }}</span>
              </div>
              <div class="post-actions">
                <form method="post" action="{% url 'reactions:post_like' post.pk %}" onclick="event.stopPropagation();">
                  {% csrf_token %}
                  <button type="submit">â™¥ {{ post.likes.count }}</button>
                </form>
                {% if user.is_authenticated and user == post.author %}
                  <button type="button" onclick="event.stopPropagation();window.location.href='{% url 'posts:post_update' post.pk %}';">Edit</button>
                  <button type="button" class="btn-danger" onclick="event.stopPropagation();window.location.href='{% url 'posts:post_delete' post.pk %}';">Del</button>
                {% endif %}
              </div>
            </div>
          </div>
        </a>
      {% empty %}
        <div class="empty-state">
          <p>// No posts yet.</p>
          {% if user.is_authenticated %}
            <a href="{% url 'posts:post_create' %}" class="btn btn-primary">Create first post</a>
          {% else %}
            <p><a href="{% url 'users:login' %}">Sign in</a> to create posts.</p>
          {% endif %}
        </div>
      {% endfor %}
    </div>

    <div id="loading" class="feed-status" style="display:none;">// Loading more posts...</div>
    <div id="no-more-posts" class="feed-status" style="display:none;">// End of feed.</div>

  </div>
</div>

<script>
  let currentPage = 1;
  let hasMore = {{ is_paginated|lower }};
  let isLoading = false;
  const searchQuery = '{{ request.GET.q }}';

  function loadMorePosts() {
    if (isLoading || !hasMore) return;
    isLoading = true;
    document.getElementById('loading').style.display = 'block';
    currentPage++;
    fetch(`{% url 'posts:posts_api' %}?page=${currentPage}&q=${searchQuery}`)
      .then(r => r.json())
      .then(data => {
        const container = document.getElementById('posts-container');
        const temp = document.createElement('div');
        temp.innerHTML = data.html;
        while (temp.firstChild) container.appendChild(temp.firstChild);
        hasMore = data.has_more;
        isLoading = false;
        document.getElementById('loading').style.display = 'none';
        if (!hasMore) document.getElementById('no-more-posts').style.display = 'block';
      })
      .catch(() => { isLoading = false; document.getElementById('loading').style.display = 'none'; });
  }

  window.addEventListener('scroll', function() {
    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) loadMorePosts();
  });
</script>
{% endblock %}