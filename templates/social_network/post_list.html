{% extends "base.html" %}
{% block title %}RetroNetwork | Posts{% endblock %}
{% block content %}

<div class="panel" style="width: 100%; max-width: 700px; margin: 0 auto;">
  <div class="panel-header">[ Post Feed ]</div>
  <div class="panel-body" style="padding:6px;">

    <div class="post-list" id="posts-container">
      {% for post in posts %}
        <div class="post">
          <div class="post-header">
            <div class="post-author">
              {{ post.author.get_display_name }} 
              {% if post.author.handle %}<a href="{% url 'users:user_detail' post.author.handle %}" onclick="event.stopPropagation();">@{{ post.author.handle }}</a>{% else %}@unknown{% endif %}
            </div>
            <div class="post-date">{{ post.created_at|date:"d.m.Y H:i" }}</div>
          </div>

          <a href="{% url 'posts:post_detail' post.pk %}" class="post-link">
            <div class="post-text">{{ post.content }}</div>

            {% if post.thumbnail_url %}
              <div class="post-media">
                <img src="/media/{{ post.thumbnail_url }}" alt="">
              </div>
            {% elif post.images or post.videos %}
              <div class="post-media">
                {% if post.images %}
                  <img src="{{ post.images.0.file.url }}" alt="">
                {% elif post.videos %}
                  <video controls><source src="{{ post.videos.0.file.url }}" type="video/mp4"></video>
                {% endif %}
              </div>
            {% endif %}
            </a>
            
            <div class="post-actions">
              <form method="post" action="{% url 'reactions:post_like' post.pk %}" onclick="event.stopPropagation();">
                {% csrf_token %}
                <button type="submit">â™¥ {{ post.likes.count }}</button>
              </form>
              <span class="comment-count">ðŸ’¬ {{ post.comments.count }}</span>
              {% if user.is_authenticated and user == post.author %}
                <button type="button" onclick="event.stopPropagation();window.location.href='{% url 'posts:post_update' post.pk %}';">Edit</button>
                <button type="button" class="btn-danger" onclick="event.stopPropagation();window.location.href='{% url 'posts:post_delete' post.pk %}';">Del</button>
              {% endif %}
            </div>
          </div>
      {% empty %}
        <div class="empty-state">
          <p>// No posts yet.</p>
          {% if user.is_authenticated %}
            <a href="{% url 'posts:post_create' %}" class="btn btn-primary">Create first post</a>
          {% else %}
            <p><a href="{% url 'users:login' %}">Sign in</a> to create posts.</p>
          {% endif %}
        </div>
      {% endfor %}
    </div>

    <div id="loading" class="feed-status" style="display:none;">// Loading more posts...</div>
    <div id="no-more-posts" class="feed-status" style="display:none;">// End of feed.</div>

  </div>
</div>

{% if is_paginated %}
  <div class="pagination" style="width: 100%; max-width: 700px; margin: 8px auto;">
    {% if page_obj.has_previous %}
      <a href="?page=1{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">Â«</a>
      <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">&lsaquo;</a>
    {% endif %}
    
    {% for num in page_obj.paginator.page_range %}
      {% if page_obj.number == num %}
        <span class="current">{{ num }}</span>
      {% else %}
        <a href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">{{ num }}</a>
      {% endif %}
    {% endfor %}
    
    {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">&rsaquo;</a>
      <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">Â»</a>
    {% endif %}
  </div>
{% endif %}

<script>
  let currentPage = 1;
  let hasMore = {{ is_paginated|lower }};
  let isLoading = false;
  const searchQuery = '{{ request.GET.q }}';

  function loadMorePosts() {
    if (isLoading || !hasMore) return;
    isLoading = true;
    document.getElementById('loading').style.display = 'block';
    currentPage++;
    fetch(`{% url 'posts:posts_api' %}?page=${currentPage}&q=${searchQuery}`)
      .then(r => r.json())
      .then(data => {
        const container = document.getElementById('posts-container');
        const temp = document.createElement('div');
        temp.innerHTML = data.html;
        while (temp.firstChild) container.appendChild(temp.firstChild);
        hasMore = data.has_more;
        isLoading = false;
        document.getElementById('loading').style.display = 'none';
        if (!hasMore) document.getElementById('no-more-posts').style.display = 'block';
      })
      .catch(() => { isLoading = false; document.getElementById('loading').style.display = 'none'; });
  }

  window.addEventListener('scroll', function() {
    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) loadMorePosts();
  });
</script>
{% endblock %}