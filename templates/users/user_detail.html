{% extends 'base.html' %}
{% block title %}{{ profile_user.get_display_name }} - RetroNetwork{% endblock %}

{% block content %}

{% if is_blocked %}
  <div class="panel">
    <div class="panel-header">[ Access Denied ]</div>
    <div class="panel-body blocked-notice">
      <h2>User Blocked</h2>
      <p>You have blocked this user. You cannot view their profile.</p>
      <div class="actions" style="justify-content:center;margin-top:12px;">
        <form method="post" action="{% url 'user_settings:unblock' profile_user.handle %}">
          {% csrf_token %}
          <button type="submit">Unblock User</button>
        </form>
        <a href="{% url 'posts:post_list' %}" class="btn">Go back</a>
      </div>
    </div>
  </div>

{% elif not can_view_profile %}
  <div class="panel">
    <div class="panel-header">[ Private Profile ]</div>
    <div class="panel-body private-notice">
      <h2>This Profile is Private</h2>
      <p>
        {% if privacy_visibility == "none" %}Only the owner can view this profile.
        {% elif privacy_visibility == "friends" %}This profile is visible to friends only.
        {% endif %}
      </p>
      <a href="{% url 'posts:post_list' %}" class="btn" style="margin-top:12px;">Go back</a>
    </div>
  </div>

{% else %}

  <div class="panel">
    <div class="panel-header">[ {{ profile_user.get_display_name }} ]</div>
    <div class="panel-body" style="padding:0;">

      <div class="profile-header">
        <div class="profile-avatar">
          {% if profile_user.avatar %}
            <img src="{{ profile_user.avatar.url }}" alt="Avatar">
          {% else %}
            <div class="profile-avatar-placeholder">ðŸ‘¤</div>
          {% endif %}
        </div>
        <div class="profile-info">
          <h1>{{ profile_user.get_display_name }}</h1>
          <p class="profile-handle">@{{ profile_user.handle }}<span class="online-dot"></span></p>
          {% if profile_user.bio %}<p class="profile-bio">{{ profile_user.bio }}</p>{% endif %}
          <p class="profile-meta"><strong>Followers:</strong> {{ profile_user.followers.count }}</p>
        </div>
      </div>

      <table class="profile-table">
        <tr><td>Email</td><td>{{ profile_user.email }}</td></tr>
        {% if profile_user.birth_date %}
          <tr><td>Birth Date</td><td>{{ profile_user.birth_date|date:"F d, Y" }}</td></tr>
        {% endif %}
      </table>

      <!-- ÐšÐ½Ð¾Ð¿ÐºÐ¸ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ -->
      <div class="profile-actions-bar">
        {% if is_own_profile %}
          <a href="{% url 'user_settings:edit_profile' %}" class="btn">Edit Profile</a>
          <a href="{% url 'user_settings:friends_list' profile_user.handle %}" class="btn">Friends</a>
          <a href="{% url 'user_settings:privacy_settings' %}" class="btn">Privacy</a>
        {% else %}
          <a href="{% url 'user_settings:friends_list' profile_user.handle %}" class="btn">Friends</a>

          {% if user.is_authenticated %}
            {% if is_following %}
              <form method="post" action="{% url 'users:unfollow' profile_user.handle %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit">âœ“ Following</button>
              </form>
            {% else %}
              <form method="post" action="{% url 'users:follow' profile_user.handle %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit">Follow</button>
              </form>
            {% endif %}

            {% if friend_request %}
              {% if friend_request_status == "pending" %}
                {% if friend_request.receiver == user %}
                  <form method="post" action="{% url 'user_settings:accept_friend_request' profile_user.handle %}" style="display:inline;">
                    {% csrf_token %}<button type="submit">Accept Friend Req</button>
                  </form>
                  <form method="post" action="{% url 'user_settings:reject_friend_request' profile_user.handle %}" style="display:inline;">
                    {% csrf_token %}<button type="submit" class="btn-danger">Reject</button>
                  </form>
                {% else %}
                  <button disabled>Request Sent</button>
                {% endif %}
              {% elif friend_request_status == "accepted" %}
                <button disabled>âœ“ Friends</button>
              {% endif %}
            {% else %}
              <form method="post" action="{% url 'user_settings:send_friend_request' profile_user.handle %}" style="display:inline;">
                {% csrf_token %}<button type="submit">Add Friend</button>
              </form>
            {% endif %}

            {% if is_blocking %}
              <form method="post" action="{% url 'user_settings:unblock' profile_user.handle %}" style="display:inline;">
                {% csrf_token %}<button type="submit" class="btn btn-danger">Unblock</button>
              </form>
            {% else %}
              <form method="post" action="{% url 'user_settings:block' profile_user.handle %}" style="display:inline;">
                {% csrf_token %}<button type="submit" class="btn btn-danger">Block</button>
              </form>
            {% endif %}
          {% endif %}
        {% endif %}
      </div>

    </div>
  </div>

  {% if can_view_profile %}
    <div class="panel">
      <div class="panel-header">[ Posts ]</div>
      <div class="panel-body" style="padding:6px;">
        {% if posts %}
          <div class="user-posts">
            {% for post in posts %}
              <a href="{% url 'posts:post_detail' post.id %}" class="post-link">
                <div class="user-post">
                  {% if post.thumbnail_url %}
                    <div class="user-post-thumbnail-container">
                      <img src="/media/{{ post.thumbnail_url }}" alt="{{ post.title }}">
                      <div class="user-post-thumbnail-overlay"></div>
                    </div>
                  {% elif post.images or post.videos %}
                    <div class="user-post-thumbnail-container">
                      {% if post.images %}<img src="{{ post.images.0.file.url }}" alt="{{ post.title }}">
                      {% elif post.videos %}<video><source src="{{ post.videos.0.file.url }}" type="video/mp4"></video>{% endif %}
                      <div class="user-post-thumbnail-overlay"></div>
                    </div>
                  {% endif %}
                  <h3 class="user-post-title">{{ post.title }}</h3>
                  <p class="user-post-description">{{ post.description }}</p>
                  <small class="user-post-date">{{ post.created_at|date:"d.m.Y H:i" }}</small>
                </div>
              </a>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty-state">// No posts yet.</div>
        {% endif %}
      </div>
    </div>
  {% endif %}

{% endif %}
{% endblock %}